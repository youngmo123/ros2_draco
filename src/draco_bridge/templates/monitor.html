<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draco Bridge Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .status-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px 0;
        }
        
        .status-indicator {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .connected {
            background: #4CAF50;
            color: white;
        }
        
        .disconnected {
            background: #f44336;
            color: white;
        }
        
        .compression-info {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .size-display {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            margin: 5px 0;
        }
        
        .ratio-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #2196F3;
            text-align: center;
            margin: 10px 0;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 15px;
            max-height: 350px;
        }
        
        .chart-title {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .system-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2196F3;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .timestamp {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Draco Bridge Monitor</h1>
            <p>실시간 압축 및 네트워크 상태 모니터링</p>
        </div>
        
        <div class="status-grid">
            <!-- 연결 상태 카드 (간소화) -->
            <div class="status-card">
                <h3>🔗 연결 상태</h3>
                <div class="status-item">
                    <span>인코더 서버:</span>
                    <span class="status-indicator disconnected" id="encoder-status">연결 끊김</span>
                </div>
                <div class="status-item">
                    <span>디코더 클라이언트:</span>
                    <span class="status-indicator disconnected" id="decoder-status">연결 끊김</span>
                </div>
                <div class="status-item">
                    <span>네트워크 연결:</span>
                    <span class="status-indicator disconnected" id="network-status">연결 끊김</span>
                </div>
                <div class="status-item">
                    <span>활성 연결 수:</span>
                    <span id="connection-count">0</span>
                </div>
            </div>
            
            <!-- 네트워크 대역폭 카드 (새로 추가) -->
            <div class="status-card">
                <h3>🌐 네트워크 대역폭</h3>
                <div class="status-item">
                    <span>송신 대역폭:</span>
                    <span id="bandwidth-sent">0 B/s</span>
                </div>
                <div class="status-item">
                    <span>수신 대역폭:</span>
                    <span id="bandwidth-recv">0 B/s</span>
                </div>
                <div class="status-item">
                    <span>전송 속도 (bps):</span>
                    <span id="upload-bps">0 bps</span>
                </div>
                <div class="status-item">
                    <span>수신 속도 (bps):</span>
                    <span id="download-bps">0 bps</span>
                </div>
                <div class="status-item">
                    <span>실시간 업로드:</span>
                    <span id="realtime-upload">0.00 Mbps</span>
                </div>
                <div class="status-item">
                    <span>실시간 다운로드:</span>
                    <span id="realtime-download">0.00 Mbps</span>
                </div>
                <div class="status-item">
                    <span>테스트 상태:</span>
                    <span id="test-status">대기 중</span>
                </div>
                <div class="status-item">
                    <span>마지막 테스트:</span>
                    <span id="last-test-time">-</span>
                </div>
            </div>
            
            <!-- 압축 정보 카드 -->
            <div class="status-card">
                <h3>📊 압축 통계</h3>
                <div class="compression-info">
                    <div class="size-display">원본 크기: <span id="original-size">0</span> bytes</div>
                    <div class="size-display">압축 크기: <span id="compressed-size">0</span> bytes</div>
                    <div class="ratio-display" id="compression-ratio">0%</div>
                    <div style="text-align: center; color: #666; font-size: 0.9em;">
                        마지막 업데이트: <span id="last-update">-</span>
                    </div>
                </div>
            </div>
            
            <!-- 시스템 정보 카드 -->
            <div class="status-card">
                <h3>💻 시스템 정보</h3>
                <div class="system-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="cpu-percent">0%</div>
                        <div class="stat-label">CPU 사용률</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="memory-percent">0%</div>
                        <div class="stat-label">메모리 사용률</div>
                    </div>
                </div>
                <div style="margin-top: 15px; font-size: 0.9em; color: #666;">
                    <div>메모리: <span id="memory-used">0</span>GB / <span id="memory-total">0</span>GB</div>
                </div>
            </div>
        </div>
        
        <!-- 차트 컨테이너 -->
        <div class="chart-container">
            <div class="chart-title">📈 압축률 추이</div>
            <canvas id="compressionChart" width="400" height="180"></canvas>
        </div>
        
        <div class="timestamp">
            마지막 업데이트: <span id="timestamp">-</span>
        </div>
    </div>

    <script>
        // Socket.IO 연결
        const socket = io();
        
        // 차트 설정
        const ctx = document.getElementById('compressionChart').getContext('2d');
        const compressionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '압축률 (%)',
                    data: [],
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            display: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // 상태 업데이트 함수
        function updateStatus(data) {
            // 연결 상태 업데이트
            updateStatusIndicator('encoder-status', data.encoder_status);
            updateStatusIndicator('decoder-status', data.decoder_status);
            updateStatusIndicator('network-status', data.network_status);
            
            // 연결 수 업데이트
            document.getElementById('connection-count').textContent = data.connection_count;
            
            // 네트워크 대역폭 업데이트
            document.getElementById('bandwidth-sent').textContent = formatBytes(data.network_bandwidth.bytes_sent_per_sec) + '/s';
            document.getElementById('bandwidth-recv').textContent = formatBytes(data.network_bandwidth.bytes_recv_per_sec) + '/s';
            
            // 고급 대역폭 정보 업데이트
            if (data.bandwidth_results) {
                const bw = data.bandwidth_results;
                
                // 전송/수신 속도 (bps)
                document.getElementById('upload-bps').textContent = formatBps(parseFloat(bw.upload_speed_bps || 0));
                document.getElementById('download-bps').textContent = formatBps(parseFloat(bw.download_speed_bps || 0));
                
                // 실시간 업로드/다운로드
                document.getElementById('realtime-upload').textContent = (bw.realtime_upload_mbps || '0.00') + ' Mbps';
                document.getElementById('realtime-download').textContent = (bw.realtime_download_mbps || '0.00') + ' Mbps';
                
                // 테스트 상태
                document.getElementById('test-status').textContent = getTestStatusText(bw.test_status);
                document.getElementById('last-test-time').textContent = bw.last_test_time || '-';
            }
            
            // 압축 통계 업데이트
            document.getElementById('original-size').textContent = formatBytes(data.compression_stats.original_size);
            document.getElementById('compressed-size').textContent = formatBytes(data.compression_stats.compressed_size);
            document.getElementById('compression-ratio').textContent = data.compression_stats.compression_ratio + '%';
            document.getElementById('last-update').textContent = data.compression_stats.last_update || '-';
            
            // 시스템 정보 업데이트
            document.getElementById('cpu-percent').textContent = data.system_info.cpu_percent.toFixed(1) + '%';
            document.getElementById('memory-percent').textContent = data.system_info.memory_percent.toFixed(1) + '%';
            document.getElementById('memory-used').textContent = data.system_info.memory_used_gb;
            document.getElementById('memory-total').textContent = data.system_info.memory_total_gb;
            
            // 타임스탬프 업데이트
            document.getElementById('timestamp').textContent = data.timestamp;
            
            // 차트 업데이트
            updateChart(data.compression_stats.compression_ratio);
        }
        
        function updateStatusIndicator(elementId, status) {
            const element = document.getElementById(elementId);
            if (status === 'connected') {
                element.textContent = '연결됨';
                element.className = 'status-indicator connected';
            } else {
                element.textContent = '연결 끊김';
                element.className = 'status-indicator disconnected';
            }
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatBps(bps) {
            if (bps === 0) return '0 bps';
            if (bps >= 1_000_000_000) {
                return (bps / 1_000_000_000).toFixed(2) + ' Gbps';
            } else if (bps >= 1_000_000) {
                return (bps / 1_000_000).toFixed(2) + ' Mbps';
            } else if (bps >= 1_000) {
                return (bps / 1_000).toFixed(2) + ' Kbps';
            } else {
                return bps.toFixed(0) + ' bps';
            }
        }
        
        function getTestStatusText(status) {
            const statusMap = {
                'idle': '대기 중',
                'testing': '테스트 중...',
                'completed': '완료',
                'failed': '실패'
            };
            return statusMap[status] || '알 수 없음';
        }
        
        function updateChart(compressionRatio) {
            const now = new Date().toLocaleTimeString();
            compressionChart.data.labels.push(now);
            compressionChart.data.datasets[0].data.push(compressionRatio);
            
            // 최대 20개 데이터 포인트만 유지
            if (compressionChart.data.labels.length > 20) {
                compressionChart.data.labels.shift();
                compressionChart.data.datasets[0].data.shift();
            }
            
            compressionChart.update('none');
        }
        
        // Socket.IO 이벤트 리스너
        socket.on('connect', function() {
            console.log('WebSocket 연결됨');
        });
        
        socket.on('status_update', function(data) {
            updateStatus(data);
        });
        
        socket.on('disconnect', function() {
            console.log('WebSocket 연결 끊김');
        });
    </script>
</body>
</html>
